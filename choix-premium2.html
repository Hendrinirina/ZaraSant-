<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prendre Rendez-vous</title>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    :root {
      --bg-color: #0f0f0f;
      --text-color: white;
      --card-bg: #1e1e1e;
      --accent: #00c3ff;
      --success: #28a745;
      --error: #dc3545;
    }

    body.light {
      --bg-color: #f5f5f5;
      --text-color: #1a1a1a;
      --card-bg: #ffffff;
      --accent: #007bff;
      --success: #28a745;
      --error: #dc3545;
    }

    body {
      margin: 0;
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', sans-serif;
      transition: 0.3s ease;
    }

    .top-bar {
      background: var(--card-bg);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #333;
    }

    .title {
      font-size: 1.3em;
      font-weight: bold;
    }

    .theme-toggle {
      cursor: pointer;
      color: var(--text-color);
    }

    .content {
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      box-sizing: border-box;
    }

    .search-section {
      background: var(--card-bg);
      padding: 20px 15px;
      border-radius: 12px;
      margin-bottom: 25px;
      text-align: center;
    }

    .search-title {
      color: var(--accent);
      text-align: center;
      margin-bottom: 20px;
    }

    .search-input {
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #555;
      background: var(--card-bg);
      color: var(--text-color);
      margin-bottom: 15px;
      font-size: 1em;
      box-sizing: border-box;
    }

    .search-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 30px;
      width: 100%;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s ease;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 0 auto;
    }

    .search-btn:hover {
      background: #0088cc;
    }

    .results-section {
      display: none;
    }

    .doctor-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      border-left: 4px solid var(--accent);
    }

    .doctor-name {
      color: var(--accent);
      margin: 0 0 10px 0;
      font-size: 1.2em;
    }

    .doctor-specialty {
      color: #aaa;
      margin: 0 0 15px 0;
      font-size: 0.9em;
    }

    .doctor-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9em;
    }

    .book-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      transition: 0.3s ease;
    }

    .book-btn:hover {
      background: #218838;
    }

    .no-results {
      text-align: center;
      color: #aaa;
      padding: 40px 0;
      display: none;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: var(--card-bg);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      border-top: 2px solid #333;
    }

    .bottom-nav a {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-color);
      text-decoration: none;
      font-size: 0.75em;
      transition: color 0.3s ease;
    }

    .bottom-nav a:hover {
      color: var(--accent);
    }

    .bottom-nav svg {
      width: 24px;
      height: 24px;
      margin-bottom: 3px;
    }

    /* Modal de rendez-vous */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-title {
      color: var(--accent);
      margin-bottom: 20px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #555;
      background: var(--card-bg);
      color: var(--text-color);
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .confirm-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      flex: 1;
      cursor: pointer;
    }

    .cancel-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      flex: 1;
      cursor: pointer;
    }

    .error-message {
      color: var(--error);
      font-size: 0.9em;
      margin-top: 5px;
      display: none;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .availability-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .calendar-day {
      text-align: center;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s ease;
    }
    
    .calendar-day.available {
      background: rgba(46, 204, 113, 0.2);
      border: 1px solid var(--success);
    }
    
    .calendar-day.unavailable {
      background: rgba(220, 53, 69, 0.2);
      border: 1px solid var(--error);
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    .calendar-day.selected {
      background: var(--success);
      color: white;
    }
    
    .calendar-header {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <header class="top-bar">
    <div class="title">Prise de rendez-vous</div>
    <div class="theme-toggle" id="themeToggle">
      <i data-lucide="sun" id="themeIcon"></i>
    </div>
  </header>

  <div class="content">
    <div class="search-section">
      <h2 class="search-title">Rechercher un médecin</h2>
      <input type="text" class="search-input" id="searchInput" placeholder="Nom du médecin ou spécialité...">
      <button class="search-btn" onclick="searchDoctors()">
        <i data-lucide="search"></i> RECHERCHER
      </button>
    </div>

    <div class="results-section" id="resultsSection">
      <!-- Les résultats seront générés dynamiquement par JavaScript -->
    </div>

    <div class="no-results" id="noResults">
      <i data-lucide="search" width="48" height="48"></i>
      <p>Utilisez la recherche pour trouver des médecins</p>
      <p>Recherchez par nom ou par spécialité</p>
    </div>

    <div class="no-results" id="noNameResults" style="display: none;">
      <i data-lucide="user-x" width="48" height="48"></i>
      <p>Aucun médecin ne porte ce nom</p>
      <p>Vérifiez l'orthographe ou essayez une autre recherche</p>
    </div>

    <div class="no-results" id="noSpecialtyResults" style="display: none;">
      <i data-lucide="stethoscope" width="48" height="48"></i>
      <p>Spécialité non trouvée</p>
      <p>Cette spécialité n'est pas encore disponible sur notre plateforme</p>
    </div>
  </div>

  <!-- Modal de prise de rendez-vous -->
  <div class="modal" id="bookingModal">
    <div class="modal-content">
      <h3 class="modal-title" id="modalDoctorName">Prendre Rendez-vous</h3>
      
      <div class="form-group">
        <label>Calendrier des disponibilités</label>
        <div class="availability-calendar" id="availabilityCalendar">
          <!-- Le calendrier sera généré dynamiquement -->
        </div>
        <div class="error-message" id="dateError">Date non disponible</div>
      </div>

      <div class="form-group">
        <label for="appointmentTime">Heure</label>
        <select id="appointmentTime">
          <option value="">Sélectionnez une heure</option>
          <!-- Les créneaux seront générés dynamiquement -->
        </select>
        <div class="error-message" id="timeError">Créneau non disponible</div>
      </div>

      <div class="form-group">
        <label for="appointmentReason">Motif de la consultation</label>
        <input type="text" id="appointmentReason" placeholder="Ex: Consultation routine, problème spécifique...">
        <div class="error-message" id="reasonError">Veuillez saisir un motif</div>
      </div>

      <div class="modal-buttons">
        <button class="cancel-btn" onclick="closeBookingModal()">Annuler</button>
        <button class="confirm-btn" id="confirmBtn" onclick="confirmAppointment()">Confirmer</button>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <a href="bitget2.html"><i data-lucide="home"></i>Accueil</a>
    <a href="formation2.html"><i data-lucide="folder-open"></i>Documents</a>
    <a href="choix-premium2.html"><i data-lucide="calendar"></i>Rendez-vous</a>
    <a href="compte2.html"><i data-lucide="user-round"></i>Compte</a>
  </nav>

  <script>
    lucide.createIcons();

    const themeToggle = document.getElementById("themeToggle");
    const themeIcon = document.getElementById("themeIcon");

    function setTheme(mode) {
      document.body.classList.remove("light", "dark");
      document.body.classList.add(mode);
      themeIcon.setAttribute("data-lucide", mode === "light" ? "moon" : "sun");
      lucide.createIcons();
      localStorage.setItem("theme", mode);
    }

    themeToggle.addEventListener("click", () => {
      const current = document.body.classList.contains("light") ? "dark" : "light";
      setTheme(current);
    });

    // Fonction pour obtenir les médecins validés depuis le localStorage
    function getApprovedDoctors() {
      return JSON.parse(localStorage.getItem('approvedDoctors') || '[]');
    }

    // Fonction pour obtenir les disponibilités des médecins
    function getDoctorAvailabilities() {
      return JSON.parse(localStorage.getItem('doctorAvailabilities') || '[]');
    }

    // Fonction pour obtenir les rendez-vous existants
    function getAppointments() {
      return JSON.parse(localStorage.getItem('appointments') || '[]');
    }

    // Fonction pour générer des termes de recherche à partir du nom et de la spécialité
    function generateSearchTerms(doctor) {
      const terms = [];
      
      // Ajouter le nom complet
      terms.push(doctor.lastName.toLowerCase());
      terms.push(doctor.firstName.toLowerCase());
      terms.push(`${doctor.firstName.toLowerCase()} ${doctor.lastName.toLowerCase()}`);
      
      // Ajouter la spécialité
      terms.push(doctor.specialty.toLowerCase());
      
      // Ajouter des variations de la spécialité
      if (doctor.specialty.includes('é')) {
        terms.push(doctor.specialty.toLowerCase().replace('é', 'e'));
      }
      if (doctor.specialty.includes('è')) {
        terms.push(doctor.specialty.toLowerCase().replace('è', 'e'));
      }
      
      // Ajouter des mots-clés selon la spécialité
      if (doctor.specialty.toLowerCase().includes('cardio')) {
        terms.push('cœur', 'coeur', 'cardio');
      } else if (doctor.specialty.toLowerCase().includes('pédiatre') || doctor.specialty.toLowerCase().includes('pediatre')) {
        terms.push('enfant', 'enfants', 'bébé', 'bebe', 'zaza');
      } else if (doctor.specialty.toLowerCase().includes('dentiste')) {
        terms.push('dent', 'dents', 'nify');
      } else if (doctor.specialty.toLowerCase().includes('gynéco') || doctor.specialty.toLowerCase().includes('gyneco')) {
        terms.push('femme', 'gynéco', 'gyneco');
      } else if (doctor.specialty.toLowerCase().includes('ophtalmo')) {
        terms.push('yeux', 'maso', 'vue');
      } else if (doctor.specialty.toLowerCase().includes('dermato')) {
        terms.push('peau', 'hoditra');
      }
      
      return terms;
    }

    // Fonction pour vérifier la disponibilité d'un créneau
    function isTimeSlotAvailable(doctorEmail, date, time) {
      // Vérifier les rendez-vous existants
      const appointments = getAppointments();
      const hasConflict = appointments.some(app => 
        app.doctor.email === doctorEmail && 
        app.date === date && 
        app.time === time &&
        app.status !== 'cancelled'
      );
      
      if (hasConflict) return false;
      
      // Vérifier les disponibilités du médecin
      const availabilities = getDoctorAvailabilities();
      const dayOfWeek = new Date(date).toLocaleDateString('fr-FR', { weekday: 'long' }).toLowerCase();
      
      const doctorAvailability = availabilities.find(av => 
        av.doctorEmail === doctorEmail && av.day.toLowerCase() === dayOfWeek
      );
      
      if (!doctorAvailability) return false;
      
      return doctorAvailability.slots.includes(time);
    }

    // Fonction pour formater les médecins pour l'affichage
    function formatDoctorsForDisplay(approvedDoctors) {
      return approvedDoctors.map(doctor => {
        // Vérifier les disponibilités du médecin
        const availabilities = getDoctorAvailabilities();
        const doctorAvailabilities = availabilities.filter(av => av.doctorEmail === doctor.email);
        
        let availabilityText = "Non disponible";
        if (doctorAvailabilities.length > 0) {
          const days = doctorAvailabilities.map(av => av.day.charAt(0).toUpperCase() + av.day.slice(1));
          availabilityText = `Disponible: ${days.join(', ')}`;
        }
        
        return {
          name: `Dr. ${doctor.firstName} ${doctor.lastName}`,
          specialty: doctor.specialty,
          availability: availabilityText,
          searchTerms: generateSearchTerms(doctor),
          doctorData: doctor, // Conserver les données originales
          hasAvailability: doctorAvailabilities.length > 0
        };
      });
    }

    let currentDoctor = null;
    let selectedDate = null;

    function searchDoctors() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      const resultsSection = document.getElementById('resultsSection');
      const noResults = document.getElementById('noResults');
      const noNameResults = document.getElementById('noNameResults');
      const noSpecialtyResults = document.getElementById('noSpecialtyResults');
      
      // Masquer tous les messages d'erreur d'abord
      noResults.style.display = 'none';
      noNameResults.style.display = 'none';
      noSpecialtyResults.style.display = 'none';
      
      if (searchTerm === '') {
        noResults.style.display = 'block';
        resultsSection.style.display = 'none';
        return;
      }
      
      // Récupérer les médecins validés
      const approvedDoctors = getApprovedDoctors();
      
      if (approvedDoctors.length === 0) {
        noResults.style.display = 'block';
        resultsSection.style.display = 'none';
        return;
      }
      
      // Formater les médecins pour l'affichage
      const displayDoctors = formatDoctorsForDisplay(approvedDoctors);
      
      // Filtrer les médecins selon la recherche
      const filteredDoctors = displayDoctors.filter(doctor => 
        doctor.searchTerms.some(term => term.includes(searchTerm)) ||
        doctor.name.toLowerCase().includes(searchTerm) ||
        doctor.specialty.toLowerCase().includes(searchTerm)
      );
      
      if (filteredDoctors.length === 0) {
        resultsSection.style.display = 'none';
        
        // Déterminer le type d'erreur
        const isNameSearch = /^[a-zéèêëàâäôöûüç\s]+$/i.test(searchTerm);
        const isSpecialtySearch = !isNameSearch || searchTerm.length > 3;
        
        if (isNameSearch) {
          noNameResults.style.display = 'block';
        } else {
          noSpecialtyResults.style.display = 'block';
        }
        return;
      }
      
      // Afficher les résultats
      resultsSection.innerHTML = '';
      resultsSection.style.display = 'block';
      
      filteredDoctors.forEach(doctor => {
        const doctorCard = document.createElement('div');
        doctorCard.className = 'doctor-card';
        
        let availabilityIcon = 'clock';
        let availabilityClass = '';
        
        if (!doctor.hasAvailability) {
          availabilityIcon = 'x-circle';
          availabilityClass = 'no-availability';
        }
        
        doctorCard.innerHTML = `
          <h3 class="doctor-name">${doctor.name}</h3>
          <p class="doctor-specialty">${doctor.specialty}</p>
          <div class="doctor-info">
            <span class="info-item ${availabilityClass}"><i data-lucide="${availabilityIcon}"></i> ${doctor.availability}</span>
          </div>
          <button class="book-btn" ${!doctor.hasAvailability ? 'disabled style="background: #6c757d; cursor: not-allowed;"' : ''} 
            onclick="openBookingModal('${doctor.name}', '${doctor.specialty}', '${doctor.doctorData.email}')">
            <i data-lucide="calendar"></i> 
            ${doctor.hasAvailability ? 'PRENDRE RENDEZ-VOUS' : 'NON DISPONIBLE'}
          </button>
        `;
        resultsSection.appendChild(doctorCard);
      });
      
      // Recréer les icônes Lucide pour les nouveaux éléments
      lucide.createIcons();
    }

    function openBookingModal(doctorName, specialty, doctorEmail) {
      // Stocker les informations du médecin sélectionné
      currentDoctor = {
        name: doctorName,
        specialty: specialty,
        email: doctorEmail
      };
      
      document.getElementById('modalDoctorName').textContent = `Rendez-vous avec ${doctorName} - ${specialty}`;
      document.getElementById('bookingModal').style.display = 'flex';
      
      // Réinitialiser les champs
      document.getElementById('appointmentTime').innerHTML = '<option value="">Sélectionnez une heure</option>';
      document.getElementById('appointmentReason').value = '';
      
      // Masquer les messages d'erreur
      document.getElementById('dateError').style.display = 'none';
      document.getElementById('timeError').style.display = 'none';
      document.getElementById('reasonError').style.display = 'none';
      
      // Générer le calendrier des disponibilités
      generateAvailabilityCalendar(doctorEmail);
    }

    function generateAvailabilityCalendar(doctorEmail) {
      const calendar = document.getElementById('availabilityCalendar');
      calendar.innerHTML = '';
      
      // Ajouter les en-têtes de jours
      const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
      days.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-header';
        dayHeader.textContent = day;
        calendar.appendChild(dayHeader);
      });
      
      // Récupérer les disponibilités du médecin
      const availabilities = getDoctorAvailabilities();
      const doctorAvailabilities = availabilities.filter(av => av.doctorEmail === doctorEmail);
      
      // Créer un calendrier pour les 30 prochains jours
      const today = new Date();
      for (let i = 0; i < 30; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        
        const dayOfWeek = date.toLocaleDateString('fr-FR', { weekday: 'long' }).toLowerCase();
        const dateString = date.toISOString().split('T')[0];
        const dayNumber = date.getDate();
        
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.textContent = dayNumber;
        dayElement.setAttribute('data-date', dateString);
        
        // Vérifier si le médecin est disponible ce jour
        const isAvailable = doctorAvailabilities.some(av => av.day.toLowerCase() === dayOfWeek);
        
        if (isAvailable) {
          dayElement.classList.add('available');
          dayElement.addEventListener('click', () => selectDate(dateString, dayElement));
        } else {
          dayElement.classList.add('unavailable');
        }
        
        calendar.appendChild(dayElement);
      }
    }

    function selectDate(date, element) {
      selectedDate = date;
      
      // Mettre à jour la sélection visuelle
      document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('selected');
      });
      element.classList.add('selected');
      
      // Mettre à jour les créneaux horaires disponibles
      updateAvailableTimeSlots();
    }

    function updateAvailableTimeSlots() {
      const timeSelect = document.getElementById('appointmentTime');
      const dateError = document.getElementById('dateError');
      
      if (!selectedDate) {
        timeSelect.innerHTML = '<option value="">Sélectionnez une heure</option>';
        return;
      }
      
      // Vérifier si la date est valide (aujourd'hui ou future)
      const selectedDateObj = new Date(selectedDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      if (selectedDateObj < today) {
        dateError.textContent = 'Veuillez sélectionner une date future';
        dateError.style.display = 'block';
        timeSelect.innerHTML = '<option value="">Sélectionnez une heure</option>';
        return;
      }
      
      dateError.style.display = 'none';
      
      // Récupérer les disponibilités du médecin pour ce jour de la semaine
      const dayOfWeek = selectedDateObj.toLocaleDateString('fr-FR', { weekday: 'long' }).toLowerCase();
      const availabilities = getDoctorAvailabilities();
      const doctorAvailability = availabilities.find(av => 
        av.doctorEmail === currentDoctor.email && av.day.toLowerCase() === dayOfWeek
      );
      
      if (!doctorAvailability) {
        timeSelect.innerHTML = '<option value="">Aucun créneau disponible</option>';
        return;
      }
      
      // Filtrer les créneaux déjà pris
      const availableTimeSlots = doctorAvailability.slots.filter(time => 
        isTimeSlotAvailable(currentDoctor.email, selectedDate, time)
      );
      
      // Mettre à jour la liste déroulante des heures
      timeSelect.innerHTML = '<option value="">Sélectionnez une heure</option>';
      
      if (availableTimeSlots.length === 0) {
        timeSelect.innerHTML = '<option value="">Aucun créneau disponible</option>';
      } else {
        availableTimeSlots.forEach(time => {
          const option = document.createElement('option');
          option.value = time;
          option.textContent = time;
          timeSelect.appendChild(option);
        });
      }
    }

    function closeBookingModal() {
      document.getElementById('bookingModal').style.display = 'none';
      // Reset form
      document.getElementById('appointmentTime').value = '';
      document.getElementById('appointmentReason').value = '';
      currentDoctor = null;
      selectedDate = null;
    }

    function confirmAppointment() {
      const time = document.getElementById('appointmentTime').value;
      const reason = document.getElementById('appointmentReason').value;
      
      const dateError = document.getElementById('dateError');
      const timeError = document.getElementById('timeError');
      const reasonError = document.getElementById('reasonError');
      const confirmBtn = document.getElementById('confirmBtn');
      
      // Réinitialiser les messages d'erreur
      dateError.style.display = 'none';
      timeError.style.display = 'none';
      reasonError.style.display = 'none';
      
      let isValid = true;
      
      if (!selectedDate) {
        dateError.textContent = 'Veuillez sélectionner une date';
        dateError.style.display = 'block';
        isValid = false;
      }
      
      if (!time) {
        timeError.textContent = 'Veuillez sélectionner une heure';
        timeError.style.display = 'block';
        isValid = false;
      }
      
      if (!reason.trim()) {
        reasonError.textContent = 'Veuillez saisir un motif';
        reasonError.style.display = 'block';
        isValid = false;
      }
      
      if (!isValid) return;
      
      // Vérifier à nouveau la disponibilité (au cas où quelqu'un d'autre aurait pris le créneau)
      if (!isTimeSlotAvailable(currentDoctor.email, selectedDate, time)) {
        timeError.textContent = 'Ce créneau n\'est plus disponible';
        timeError.style.display = 'block';
        updateAvailableTimeSlots(); // Mettre à jour les créneaux disponibles
        return;
      }
      
      if (!currentDoctor) {
        alert('Erreur: Médecin non sélectionné');
        return;
      }
      
      // Récupérer l'utilisateur connecté
      const currentUserEmail = localStorage.getItem('currentUser');
      if (!currentUserEmail) {
        alert('Veuillez vous connecter pour prendre un rendez-vous');
        window.location.href = 'auth.html?login=true';
        return;
      }
      
      // Récupérer les informations du patient
      const userAccounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
      const currentUser = userAccounts.find(user => user.email === currentUserEmail);
      
      if (!currentUser) {
        alert('Erreur: Utilisateur non trouvé');
        return;
      }
      
      // Afficher un indicateur de chargement
      const originalText = confirmBtn.textContent;
      confirmBtn.innerHTML = '<div class="loading"></div>';
      confirmBtn.disabled = true;
      
      // Simuler un délai de traitement
      setTimeout(() => {
        // Créer l'objet rendez-vous
        const appointment = {
          id: Date.now().toString(),
          patient: {
            firstName: currentUser.firstName,
            lastName: currentUser.lastName,
            email: currentUser.email,
            phone: currentUser.phone
          },
          doctor: {
            name: currentDoctor.name,
            specialty: currentDoctor.specialty,
            email: currentDoctor.email
          },
          date: selectedDate,
          time: time,
          reason: reason,
          status: 'confirmed',
          createdAt: new Date().toISOString()
        };
        
        // Stocker le rendez-vous
        const appointments = getAppointments();
        appointments.push(appointment);
        localStorage.setItem('appointments', JSON.stringify(appointments));
        
        // Restaurer le bouton de confirmation
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
        
        // Confirmation
        alert(`✅ Rendez-vous confirmé !\n\nMédecin: ${currentDoctor.name}\nSpécialité: ${currentDoctor.specialty}\nDate: ${selectedDate}\nHeure: ${time}\nMotif: ${reason}\n\nVous recevrez un rappel par email.`);
        
        closeBookingModal();
      }, 1000);
    }

    setTheme(localStorage.getItem("theme") || "dark");
  </script>
</body>
</html>
